const formidable=require('formidable');const fs=require('fs');module.exports.config={api:{bodyParser:false}};module.exports=async(req,res)=>{try{if(req.method!=='POST'){res.statusCode=405;return res.end('Method Not Allowed')}const W=process.env.DISCORD_WEBHOOK_URL,C=process.env.CLOUDINARY_CLOUD_NAME,P=process.env.CLOUDINARY_UPLOAD_PRESET;if(!W||!C||!P){res.statusCode=500;return res.end('Missing env vars.')}const form=formidable({multiples:true,keepExtensions:true,maxFileSize:20*1024*1024});form.parse(req,async(err,fields,files)=>{if(err){res.statusCode=400;return res.end('Bad form data: '+err.message)}const raw=files['images[]']||files.images||[];const imgs=Array.isArray(raw)?raw.slice(0,4):(raw&&raw.filepath?[raw]:[]);const uploaded=[];for(const f of imgs){try{const data=fs.readFileSync(f.filepath);const b64=data.toString('base64');const p=new URLSearchParams();p.append('file',`data:${f.mimetype};base64,${b64}`);p.append('upload_preset',P);const u=`https://api.cloudinary.com/v1_1/${C}/image/upload`;const up=await fetch(u,{method:'POST',body:p});const js=await up.json();if(!up.ok)throw new Error(JSON.stringify(js));uploaded.push(js.secure_url)}catch(e){console.error('Cloudinary error:',e)}}const content=`**New Request â€” NextArc Studio**\n**Category:** ${String(fields.category||'')}\n**Budget:** $${String(fields.budget||'')}\n**Deadline:** ${String(fields.deadline||'')}\n**Contact:** ${String(fields.contact||'')}\n**Details:** ${String(fields.details||'')}\n`+(uploaded.length?`\n**Images:**\n${uploaded.map(u=>`<${u}>`).join('\n')}`:'');const rsp=await fetch(W,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({content})});if(!rsp.ok){const t=await rsp.text();res.statusCode=500;return res.end('Discord error: '+t)}res.statusCode=200;res.setHeader('Content-Type','application/json');res.end(JSON.stringify({ok:true,images:uploaded}))})}catch(e){console.error(e);res.statusCode=500;res.end('Server error')}};